---
- name: Install matrics and log exporters
  hosts: all:!laptop
  become: true
  vars_files:
    - ../secrets.yml
  roles:
    - role: node_exporter
      tags:
        - node_exporter
    - role: promtail
      tags:
        - promtail
      vars:
        promtail_loki_server_url: http://{{ hostvars['loki'].ansible_host | ansible.utils.ipv4 }}:3100
        promtail_config_scrape_configs:
          - job_name: journal
            journal:
              json: false
              max_age: 12h
              path: /run/log/journal/{{ hostvars[inventory_hostname].ansible_machine_id }}/
              labels:
                node: "{{ inventory_hostname }}"
            relabel_configs: # todo seperate per instance logging and get nice relabel configs
              - action: keep
                source_labels:
                  - __journal__systemd_unit
                target_label: unit!
  post_tasks:
    - name: Reload promtail
      ansible.builtin.systemd_service:
        name: promtail
        state: restarted
      ignore_errors: true
      tags:
        - promtail

- name: Install and setup prometheus
  hosts: prometheus
  vars_files:
    - ../secrets.yml
  roles:
    - prometheus.prometheus.prometheus
  post_tasks:
    - name: Add file sd targets
      ansible.builtin.template:
        src: ../templates/targets.yml.j2
        dest: /etc/prometheus/file_sd/node.yml
        mode: "755"
        owner: prometheus
        group: prometheus
      tags:
        - prometheus
        - service_discovery
  tags:
    - prometheus
- name: Install and setup loki
  hosts: loki
  roles:
    - role: ../roles/loki
  tags:
    - loki
- name: Install and setup granfana
  hosts: grafana
  roles:
    - role: grafana.grafana.grafana
  vars_files:
    - ../secrets.yml
  vars:
    grafana_security:
      admin_user: olivia
      admin_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30376336363034656130623566623539306433326533386161613331303630346239346131373864
          6631393539366363626530306531313462613339326632320a643461366265316630626133636635
          39616238666430353834326366356562366630633137323437363138356132366537663933396235
          6163353439333035370a613036343632363331316539613437363235623031326331366435656236
          65383234666235333762393565633466363762356265643731663961353933626261
    grafana_datasources:
      - name: prometheus
        type: prometheus
        access: proxy
        url: http://{{ hostvars["prometheus"].ansible_host | ansible.utils.ipv4 }}:9090
        basicAuth: false
      - name: loki
        type: loki
        access: proxy
        url: http://{{ hostvars["loki"].ansible_host | ansible.utils.ipv4 }}:3100
        basicAuth: false
    grafana_dashboards:
      - dashboard_id: 1860
        revision_id: 37
        datasource: prometheus
    grafana_alerting: {}
  tags:
    - grafana
