---
# tasks file for arrstack
- name: Install docker
  block:
    - name: Remove podman docker
      ansible.builtin.dnf:
        name:
          - docker
          - podman-docker
          - podman
        state: absent
      become: true
    - name: Add docker ce repo
      ansible.builtin.command:
        cmd: dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
      become: true
      register: result
      changed_when: result.rc != 0
    - name: Update dnf
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_only: true
      become: true
    - name: Install docker
      ansible.builtin.dnf:
        name:
          - docker-ce
        state: present
      become: true
    - name: Start docker service
      ansible.builtin.systemd_service:
        name: docker
        state: started
        enabled: true
      become: true
- name: Mount storage drive
  ansible.posix.mount:
    src: /dev/sda
    path: "{{ arrstack_data_dir }}"
    state: mounted
    fstype: btrfs
- name: Make config directories with correct perms
  ansible.builtin.file:
    path: "{{ arrstack_dir }}/{{ item }}"
    owner: 911
    group: 911
    mode: "755"
  loop:
    - .config
    - .config/qbittorrent
    - .config/qbittorrent/config
    - .config/sonarr
    - .config/radarr
    - .config/prowlarr
  become: true
- name: Copy docker compose template file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ arrstack_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "755"
  become: true
- name: Start doker compose
  community.docker.docker_compose_v2:
    project_name: arrstack
    project_src: "{{ arrstack_dir }}"
  become: true
